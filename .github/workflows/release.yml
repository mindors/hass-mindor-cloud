name: Release

on:
  release:
    types: [published]

jobs:
  release-zip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: éªŒè¯ç‰ˆæœ¬ä¿¡æ¯
        run: |
          # è·å– release tag ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF_NAME#v}
          echo "Release version: $VERSION"
          
          # æ£€æŸ¥ manifest.json ä¸­çš„ç‰ˆæœ¬æ˜¯å¦åŒ¹é…
          MANIFEST_VERSION=$(grep -o '"version": "[^"]*"' custom_components/mindor_cloud/manifest.json | cut -d'"' -f4)
          echo "Manifest version: $MANIFEST_VERSION"
          
          if [ "$VERSION" != "$MANIFEST_VERSION" ]; then
            echo "âš ï¸  Warning: Release version ($VERSION) doesn't match manifest version ($MANIFEST_VERSION)"
          else
            echo "âœ… Version check passed"
          fi

      - name: ç”Ÿæˆ HACS å…¼å®¹çš„å‹ç¼©åŒ…
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          mkdir -p temp_build/mindor_cloud
          
          # å¤åˆ¶ç»„ä»¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          cp -r custom_components/mindor_cloud/* temp_build/mindor_cloud/
          
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
          find temp_build/ -name "*.pyc" -delete
          find temp_build/ -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find temp_build/ -name ".DS_Store" -delete 2>/dev/null || true
          
          # ç”Ÿæˆç¬¦åˆ HACS è§„èŒƒçš„å‹ç¼©åŒ…
          cd temp_build
          zip -r "../mindor_cloud.zip" mindor_cloud/
          cd ..
          
          # æ˜¾ç¤ºå‹ç¼©åŒ…å†…å®¹ä»¥ä¾›éªŒè¯
          echo "ğŸ“¦ å‹ç¼©åŒ…å†…å®¹ï¼š"
          unzip -l mindor_cloud.zip
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          ls -lh mindor_cloud.zip

      - name: Upload zip to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mindor_cloud.zip
          asset_name: mindor_cloud.zip
          tag: ${{ github.ref }}
          overwrite: true
          body: |
            ## Mindor Cloud Integration ${{ github.ref_name }}
            
            ### å®‰è£…æ–¹æ³•
            
            #### é€šè¿‡ HACS å®‰è£…
            1. ä¸‹è½½ `mindor_cloud.zip`
            2. åœ¨ HACS ä¸­æ·»åŠ è‡ªå®šä¹‰ä»“åº“æˆ–ç›´æ¥å®‰è£…
            
            #### æ‰‹åŠ¨å®‰è£…
            1. ä¸‹è½½ `mindor_cloud.zip`
            2. è§£å‹åˆ° `custom_components/mindor_cloud/` ç›®å½•
            3. é‡å¯ Home Assistant
            
            ### æ›´æ–°æ—¥å¿—
            è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/mindors/hass-mindor-cloud/commits/${{ github.ref_name }}) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
