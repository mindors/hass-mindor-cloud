name: Release

on:
  release:
    types: [published]

jobs:
  release-zip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: éªŒè¯ç‰ˆæœ¬ä¿¡æ¯
        run: |
          cd ${{ github.workspace }}/custom_components/mindor_cloud
          zip -r mindor_cloud.zip ./

      - name: ç”Ÿæˆ HACS å…¼å®¹çš„å‹ç¼©åŒ…
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          mkdir -p temp_build/mindor_cloud

          # å¤åˆ¶ç»„ä»¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          cp -r custom_components/mindor_cloud/* temp_build/mindor_cloud/

          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
          find temp_build/ -name "*.pyc" -delete
          find temp_build/ -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find temp_build/ -name ".DS_Store" -delete 2>/dev/null || true

          # ç”Ÿæˆç¬¦åˆ HACS è§„èŒƒçš„å‹ç¼©åŒ…
          cd temp_build
          zip -r "../mindor_cloud.zip" mindor_cloud/
          cd ..

          # æ˜¾ç¤ºå‹ç¼©åŒ…å†…å®¹ä»¥ä¾›éªŒè¯
          echo "ğŸ“¦ å‹ç¼©åŒ…å†…å®¹ï¼š"
          unzip -l mindor_cloud.zip

          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          ls -lh mindor_cloud.zip

      - name: Upload zip to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/custom_components/xiaomi_miot/xiaomi_miot.zip
          asset_name: xiaomi_miot.zip
          tag: ${{ github.ref }}
          overwrite: true
