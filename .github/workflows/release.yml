name: Release

on:
  release:
    types: [published]

jobs:
  release-zip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 验证版本信息
        run: |
          cd ${{ github.workspace }}/custom_components/mindor_cloud
          zip -r mindor_cloud.zip ./

      - name: 生成 HACS 兼容的压缩包
        run: |
          # 创建临时目录用于打包
          mkdir -p temp_build/mindor_cloud

          # 复制组件文件到临时目录
          cp -r custom_components/mindor_cloud/* temp_build/mindor_cloud/

          # 删除可能存在的临时文件和缓存
          find temp_build/ -name "*.pyc" -delete
          find temp_build/ -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find temp_build/ -name ".DS_Store" -delete 2>/dev/null || true

          # 生成符合 HACS 规范的压缩包
          cd temp_build
          zip -r "../mindor_cloud.zip" mindor_cloud/
          cd ..

          # 显示压缩包内容以供验证
          echo "📦 压缩包内容："
          unzip -l mindor_cloud.zip

          # 检查文件大小
          ls -lh mindor_cloud.zip

      - name: Upload zip to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/custom_components/xiaomi_miot/xiaomi_miot.zip
          asset_name: xiaomi_miot.zip
          tag: ${{ github.ref }}
          overwrite: true
